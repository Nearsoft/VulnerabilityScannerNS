from flask import Flask, Response, jsonify, request
from lib.utils.Scanner import Scanner
import json
import threading

app = Flask(__name__)


@app.route('/')
def hello_world():
    return 'Web Vulnerabilities Scanner'


@app.route('/scanner/start', methods=['POST'])
def start():
    request_data = request.get_json()
    if valid_json_format(request_data):
        scan = Scanner(request_data['url'],
                       request_data['vulnerabilities'],
                       request_data['idScann'],
                       request_data['Authentication_Token'])
        new_scan = threading.Thread(target=scan.start)
        new_scan.setDaemon(True)
        new_scan.start()
        return Response(json.dumps("{'status':'working'}"), status=200, mimetype="application/json")
    else:
        return Response(json.dumps("{'status':'json_error'}"), status=400, mimetype="application/json")


def valid_json_format(request_json):
    if (
            "url" in request_json and
            "vulnerabilities" in request_json and
            "Authentication_Token" in request_json and
            "idScann" in request_json):

        return True
    else:
        return False


app.run(host='0.0.0.0')
