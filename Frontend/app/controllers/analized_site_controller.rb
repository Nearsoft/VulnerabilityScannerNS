# frozen_string_literal: true

class AnalizedSiteController < ApplicationController
  def index; end
  AnalyzedSite = Struct.new(:flaws_found, :vulnerabilities, :flaws, :analysis)

  def show
    analysis_id = params[:id]

    if analysis_id.match(/^[-+]?[1-9]\d*$/)
      analysis = Analysis.find(analysis_id)
      if current_user
        if analysis.is_scan_completed == 0 || current_user.id != analysis.user_id
          redirect_back fallback_location: dashboard_path
        end
      else
        redirect_back fallback_location: dashboard_path
      end

      flaws_found = SecurityFlaw.security_flaws_count(analysis_id)
      repeatedVulnerabilities = Vulnerability.get_vulnerability_flaws(analysis_id)

      vulnerabilities = Vulnerability.get_non_repeated_vulnerabiliteis(repeatedVulnerabilities)

      flaws = SecurityFlaw.find_by_analysis_id(analysis_id).order(:vulnerability_id)
      @analyzed_site = AnalyzedSite.new(flaws_found, vulnerabilities, flaws, analysis)
    else
      redirect_back fallback_location: dashboard_path
    end

  end

  def new; end
end
